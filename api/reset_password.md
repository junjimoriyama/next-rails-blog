# 認証機能を自作している場合のパスワードリセットの流れ

> **注**: 認証機能を自作する場合、gemは使用しません。（gemを使う場合は`devise`などを使用）
>
> パスワードリセット機能のフローを説明。

## 1. パスワードリセットアカウントのアドレス入力

- ユーザーがパスワードをリセットしたいアカウントのメールアドレスを入力する。

## 2. バックエンドに送信

- フロントエンドで送信ボタンを押すと、入力されたアドレスがバックエンドに送られる。

## 3. バックエンドでトークン発行

- バックエンド側で送信されたメールアドレスに対して一時的なトークンを発行する。
- **DBに保存**:
  - 発行されたトークンと送信されたアドレスの組み合わせをデータベースに保存する。
- **トークンの削除ジョブ**:
  - トークンとアドレスを一定時間後に削除するためのジョブを作成する。
- **ハッシュ化**:
  - トークンを作成するときにハッシュ化させるためのgemが必要になる場合がある。

## 4. パスワードリセットメールの送信

- 送信されたアドレスにパスワードリセット用のメールを送信。
- メール内容には、パスワードリセット用のリンクが含まれており、そのリンクにはトークンがクエリパラメーターとして付与される。

## 5. パスワード再設定画面への遷移

- ユーザーがメール内のリンクをクリックすると、パスワード再設定画面に遷移する。（フロントエンドで実装）

## 6. パスワードとトークンをバックエンドに送信

- フロントエンドから再設定したいパスワードと、アドレス、トークンを一緒にバックエンドに送信する。

## 7. トークンとアドレスの確認

- バックエンド側で、送信されたアドレスとトークンがデータベースに保存されているかを確認する。

## 8. パスワード変更とトークン削除

- **存在している場合**:
  - トークンとアドレスの組み合わせがデータベースに存在していれば、パスワードを変更する。
- **存在しない場合**:
  - 組み合わせが存在しなければ、エラー処理を行う。
- **トークン削除**:
  - パスワードリセットが成功した場合、トークンとアドレスの組み合わせをデータベースから削除する。

## 9. パスワード変更完了通知メールの送信

- パスワード変更が完了したら、ユーザーにパスワードが変更された旨の通知メールを送信する。

## 注意点

- **ジョブの設定**:
  - ジョブは後から実行されるもので、指定した時間に実行することができる。今回は、パスワードリセットリンクの有効期限を（例: 15分後）に設定して、その時間が経過したらトークンを削除するようにジョブを設定する。

## データベースの設定

- **ユーザーテーブルにリセットトークンカラムを追加**:
  - パスワードリセットに関する情報を保存するため、ユーザーテーブルにリセットトークンのようなカラムを追加する必要がある。このようなデータベースの構造変更はマイグレーションで行う。
  - **データの追加と削除**はコンソールまたは管理画面などで実行する。

＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝

# 認証機能を自作している場合はgemは使わない。（gemを使う場合はdevice）
# パスワードリセットの流れ
# １、パスワードをリセットしたいアカウントのアドレスを入力する。
# ２、送信ボタン押すとバックエンドに送られる。
# ３、バックエンド側で送信されたアドレスに対して一時的なトークンを発行する。（送信されたアドレスとトークンの組み合わせをdbに保存）、アドレスとトークンを一定時間で削除するジョブを作成する。トークンを作るときのハッシュ化させるgemが必要になる場合がある。
# パスワードリセット用のルーティングを作る。コントローラーにアクションを用意。アクションの中で３番の処理を実行。
# ４、入力されたアドレスに対してメールを送る。内容としてはここからパスワードリセットできるというリンク（リンクのクエリパラメーターにトークンが付いている）
# ５、ユーザーがそのリンクをクリックするとパスワード再設定画面に遷移する。（フロントで実装）
# ６、フロントから再設置したいアドレス、パスワードとトークンも一緒にバックエンドに送る。
# ７、バックエンド側で送られたアドレスとトークンを見て、その組み合わせがdbに保存されているか確認。
# ８、トークンとアドレスの組み合わせがdbに存在していればパスワードの変更を行う。存在していなければエラー処理を行う。パスワードリセットしたらトークンとアドレスの組み合わせを削除。
# ユーザーテーブルにリセットトークンのようなカラムを追加する。（dbの構造を変化させるならマイグレートのみ、データの追加と削除に関してはコンソールまたは画面上で）
# 必須ライン-----------------------------------------------------------------------
# ９、パスワード変更のメールをユーザーに送る。

#ジョブは後から実行される（指定ができる）今回はパスワードリセットリンクの期限(例えば15分後)を登録。

1. routes.rbでresources :password_resets, only: [:new, :create, :edit, :update]などとルートの設定
2. フロントエンドでメールアドレスを送信 (POST /api/v1/password/reset)
- bodyにJSON形式の文字列に変換したemailの情報を含める。
3. Railsのpassword_resets#createがリクエストを受け取る
- 送られたemailを元に該当のuserを見つける。user情報を含めパスワードリセットメールを送信するためのメールクラスを呼び出す。その中のresetメソッドを呼び出す。これは非同期で送信されることを設定。
4. メールの生成と送信
- resetメソッド内でメールの生成と送信。この中で現在のuserを元にトークンの生成。メールの宛先とタイトルの設定も行う。
5. ApplicationMailerがデフォルト設定とレイアウトを提供。text,htmlの二つを用意。
- どちらにもパスワードリセットの遷移先を貼り付け、トークンも送れる様にする。
6. PasswordResetMailerで設定されていたdeliver_laterによりメールは非同期で送信
7. 
8. 
9. 
10. 
11. 

<!-- ko94/iTFaTijxOwCSL3YnCylBdwZTcq8Yd/603YOPFlJlbxfmw5CAUFnDmP3loJcq5NPI7B8EYdgMoMK+QajgyQUSWAc9gwNISCKXpFn3U0UvgvJfK8DgvAqiOC5Jk8GUvxAhZjcexLdutBLmD0fkJvMFZbXQyUQ11zcaAMIiufc2quAivYayrC6eobT98z55E93Gia1EEPuEXlV/vVxQF6aNlQ5oC0TbEFtOuGwLW3lbM8/spA4yD4S0ClP6HuXuZjiQ3KJz1A4GbY+qBn5M26RNv6XH36vErfUr7UColh1tUGmfj7p798tp7nfGbISev3Blnj1cDjxQgYSaZDHzRkGS7R79qqnSHzGiaEL8kyoMCnLHHOpbZutvS/XyQIQV87bIZ3L82IK82LUVkN6xFpB4Xj0--jQKobTEFffHIgfMu--vzwfS54USxIU7yH94iSFeA== -->